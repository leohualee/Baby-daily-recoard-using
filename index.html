<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>👶 寶寶日誌</title>
    <style>
        /* CSS 樣式：美化與結構化 */
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
        }

        h1 {
            color: #5d7596;
            text-align: center;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }

        h2 {
            color: #333;
            margin-top: 30px;
        }

        .controls {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #5d7596;
        }

        input[type="date"], button {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        button {
            background-color: #72a0c6;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
            min-width: 150px;
        }

        button:hover {
            background-color: #5d7596;
        }
        
        #status-message {
            margin-left: 20px;
            font-weight: bold;
            color: #4CAF50;
            align-self: flex-end;
            padding-bottom: 10px;
        }

        /* 資料顯示區塊 */
        #log-output {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 30px; /* 增加間距 */
        }

        .log-card {
            background-color: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            overflow: hidden; /* 確保圓角效果 */
        }

        .log-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            padding: 15px 20px;
            background-color: #72a0c6;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header .date-time {
            font-size: 0.9em;
            font-weight: normal;
            opacity: 0.9;
        }

        .log-content {
            padding: 15px 20px;
        }

        .log-section {
            border-left: 4px solid #f0f0f0;
            padding: 10px 0 10px 15px;
            margin-bottom: 15px;
        }

        .log-section h4 {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1em;
            color: #5d7596;
            display: flex;
            align-items: center;
        }
        
        .log-section h4 span {
            margin-right: 8px;
            font-size: 1.2em; /* 讓圖標大一點 */
        }

        /* 顏色主題 */
        .feeding-theme { border-left-color: #ffc107; }
        .sleeping-theme { border-left-color: #17a2b8; }
        .diaper-theme { border-left-color: #28a745; }
        .health-theme { border-left-color: #dc3545; }
        .contact-theme { border-left-color: #6c757d; } /* 新增聯絡事項主題 */

        .detail-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px 20px;
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }

        .detail-item {
            min-width: 45%; 
        }

        .detail-item strong {
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>

    <h1>🚀 寶寶日誌</h1>

    <div class="controls">
        <div class="control-group">
            <label for="start-date">起始日期</label>
            <input type="date" id="start-date">
        </div>

        <div class="control-group">
            <label for="end-date">結束日期</label>
            <input type="date" id="end-date">
        </div>

        <button onclick="filterAndDisplayLogs()">篩選並顯示日誌</button>
        <span id="status-message">正在連線至 Google 獲取最新資料...</span>
    </div>

    <h2>日誌記錄</h2>
    <div id="log-output">
        <p>資料載入完成後，會自動顯示今日記錄。</p>
    </div>

    <script>
        // 儲存解析後的資料
        let babyLogs = [];
                
        // ***************************************************************
        // *** Apps Script 服務的網頁應用程式 URL ***
        // ***************************************************************
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz6iRf6hMgf_jD-Jj9wOCnTVgP3jML8s10fcM7AF2gsblJjTbTcZIJ1RxNFrQzCWFZXZA/exec'; 
                
        const statusMessage = document.getElementById('status-message');

        /**
         * 修正日期選擇時的時區偏移。
         * 建立一個不受瀏覽器時區自動偏移影響的日期物件，確保它代表該日期的本地午夜。
         */
        function parseDateForComparison(dateString) {
            if (!dateString) return null;
            
            const parts = dateString.split('-');
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1; // 月份從 0 開始 (0-11)
            const day = parseInt(parts[2], 10);
            
            // 建立一個 Local Time (本地時區) 的日期物件，確保是該天的 00:00:00
            const localDate = new Date(year, month, day, 0, 0, 0, 0); 

            if (isNaN(localDate.getTime())) return null;
            return localDate;
        }

        /**
         * 最終修正版：根除 38 分鐘時區偏移問題。
         * 對純時間欄位（例如 08:00）則直接從字串中提取 HH:MM。
         */
        function extractTime(dateString) {
            if (!dateString) return '';
            const str = String(dateString).trim();

            // Case 1: Apps Script Date Object (Time-only columns) - 修正 38 分鐘錯誤
            if (str.includes("GMT") || str.includes("CST") || str.includes("1899")) {
                // 直接從字串中提取 HH:MM
                const timeMatch = str.match(/(\d{2}):(\d{2}):(\d{2})/);
                if (timeMatch && timeMatch.length >= 3) {
                    return `${timeMatch[1]}:${timeMatch[2]}`; 
                }
            }
            
            // Case 2: Apps Script Timestamp (Column A) - 完整的日期時間
            if (str.length > 15 && (str.includes('-') || str.includes(' ') && str.includes('20'))) {
                const d = new Date(str);
                if (!isNaN(d.getTime())) {
                    // 對於時間戳記，依賴瀏覽器的時區轉換
                    return d.toLocaleTimeString('zh-TW', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        hour12: false 
                    });
                }
            }

            // Case 3: Simple HH:MM (Fallback for文字輸入)
            if (str.match(/^\d{1,2}:\d{2}/)) {
                return str.substring(0, 5);
            }
            
            return ''; 
        }


        // 1. 載入資料：從 Apps Script URL 獲取 JSON 資料
        function loadBabyLogs() {
            statusMessage.textContent = '正在從雲端獲取最新日誌資料...';
            statusMessage.style.color = '#d9534f';

            const cacheBusterUrl = `${APPS_SCRIPT_URL}?v=${new Date().getTime()}`;

            fetch(cacheBusterUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP 錯誤! 狀態碼: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        statusMessage.textContent = `Apps Script 錯誤: ${data.error}`;
                        return;
                    }
                    
                    babyLogs = data.map(log => {
                        const fullTimestamp = String(log['時間戳記']);
                        // 這裡使用內建的 Date 轉換來獲取顯示的日期部分
                        const parsedDate = new Date(fullTimestamp); 
                        const datePart = isNaN(parsedDate.getTime()) ? '' : parsedDate.toLocaleDateString('zh-TW', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                        }).replace(/\//g, '-').replace(/^(\d{4})-(\d{2})-(\d{2})$/, '$1-$2-$3');
                        
                        return {
                            ...log, 
                            '完整時間戳記': fullTimestamp, 
                            '日期': datePart, 
                            '時間': extractTime(fullTimestamp), 
                        };
                    }).filter(log => log['日期'] && String(log['日期']).trim() !== ''); 
                    
                    statusMessage.textContent = `資料載入成功！共 ${babyLogs.length} 筆最新記錄。`;
                    statusMessage.style.color = '#4CAF50'; 

                    // 自動設定為今天
                    const today = new Date();
                    const formatDate = (date) => {
                           const y = date.getFullYear();
                           const m = String(date.getMonth() + 1).padStart(2, '0');
                           const d = String(date.getDate()).padStart(2, '0');
                           return `${y}-${m}-${d}`;
                    };
                    document.getElementById('start-date').value = formatDate(today);
                    document.getElementById('end-date').value = formatDate(today);

                    filterAndDisplayLogs();
                })
                .catch(error => {
                    statusMessage.textContent = '連線失敗，請檢查 Apps Script 設定是否正確。';
                    console.error('Fetch Error:', error);
                });
        }


        // 2. 篩選與顯示邏輯
        function filterAndDisplayLogs() {
            const outputDiv = document.getElementById('log-output');
            outputDiv.innerHTML = ''; 

            if (babyLogs.length === 0) {
                outputDiv.innerHTML = '<p>資料尚未載入或沒有記錄。</p>';
                return;
            }

            const startDateStr = document.getElementById('start-date').value;
            const endDateStr = document.getElementById('end-date').value;

            if (!startDateStr || !endDateStr) {
                outputDiv.innerHTML = '<p>請選擇起始日期和結束日期。</p>';
                return; 
            }

            // 使用修正後的函式，確保它們是本地時區的 00:00:00，避免時區偏移
            const startDate = parseDateForComparison(startDateStr);
            const endDate = parseDateForComparison(endDateStr);
            
            // 結束日期的比較範圍是到 "結束日期的下一天的午夜"
            if (endDate) {
                endDate.setDate(endDate.getDate() + 1); 
            }


            const filteredLogs = babyLogs.filter(log => {
                // 將資料庫的時間戳記轉換為毫秒數，以便與篩選的本地時間範圍比較
                const logTime = new Date(log['完整時間戳記']).getTime(); 
                
                if (isNaN(logTime) || !startDate || !endDate) {
                    return false; 
                }

                // 篩選： logTime 必須 >= 起始日期的本地午夜 AND < 結束日期的下一天的本地午夜
                return logTime >= startDate.getTime() && logTime < endDate.getTime();
            }).sort((a, b) => {
                const timeA = new Date(a['完整時間戳記']).getTime();
                const timeB = new Date(b['完整時間戳記']).getTime();
                return timeA - timeB; 
            });

            if (filteredLogs.length === 0) {
                outputDiv.innerHTML = '<p>在選定的日期範圍內沒有找到日誌記錄。</p>';
                return;
            }
            
            // 3. 渲染結果到網頁
            filteredLogs.forEach(log => {
                const card = document.createElement('div');
                card.className = 'log-card';

                const cardHeader = `
                    <div class="card-header">
                        <span>${log['日期']} ${extractTime(log['完整時間戳記'])}</span>
                        <span class="date-time">操作人：${log['您的身分是？'] || 'N/A'}</span>
                    </div>
                `;

                let contentHTML = '<div class="log-content">';
                let sectionContent = '';
                

                // A. 飲食/餵食 (黃色主題)
                sectionContent = '';
                if (log['早餐時間'] || log['午餐時間'] || log['點心時間'] || log['喝奶時間']) {
                    let foodDetails = [];

                    const breakfastMeal = log['早餐餐點'] || log['餐點(早餐)'] || log['早餐 餐點'] || (log['早餐時間'] ? log['餐點'] : undefined);
                    if (log['早餐時間']) foodDetails.push({ time: extractTime(log['早餐時間']), label: "早餐", food: breakfastMeal });
                    
                    const lunchMeal = log['午餐餐點'] || log['餐點(午餐)'] || log['午餐 餐點'] || (log['午餐時間'] ? log['餐點 1'] : undefined);
                    if (log['午餐時間']) foodDetails.push({ time: extractTime(log['午餐時間']), label: "午餐", food: lunchMeal });
                    
                    const snackMeal = log['點心餐點'] || log['餐點(點心)'] || log['點心 餐點'] || (log['點心時間'] ? log['餐點 2'] : undefined);
                    if (log['點心時間']) foodDetails.push({ time: extractTime(log['點心時間']), label: "點心", food: snackMeal });

                    if (log['喝奶時間']) {
                        foodDetails.push({ time: extractTime(log['喝奶時間']), label: "喝奶", amount: log['奶量(cc)'], isMilk: true });
                    }
                    
                    if (foodDetails.length > 0) {
                        sectionContent = foodDetails.map(f => {
                            let foodDisplay = f.food && String(f.food).trim() !== '' ? ` (${f.food})` : '';
                            
                            return `
                                <div class="detail-row">
                                    <div class="detail-item">
                                        <strong>${f.label}:</strong> ${f.time}${foodDisplay}
                                    </div>
                                    ${f.isMilk ? 
                                        `<div class="detail-item"><strong>奶量:</strong> ${f.amount || 'N/A'} cc</div>` : 
                                        ''
                                    }
                                </div>
                            `;
                        }).join('');

                        contentHTML += `<div class="log-section feeding-theme">
                            <h4><span>🍼</span> 飲食記錄</h4>${sectionContent}
                        </div>`;
                    }
                // 結構 1: 多次飲食 (舊結構) - 備用
                } else if (log['第一次 飲食'] || log['第二次 飲食'] || log['第三次 飲食']) {
                    let feedingDetails = [];
                    if (log['第一次 飲食']) feedingDetails.push({ time: extractTime(log['第一次 飲食']), label: "第一次餵食", amount: log['奶量(cc)'], other: log['其他飲食'] });
                    if (log['第二次 飲食']) feedingDetails.push({ time: extractTime(log['第二次 飲食']), label: "第二次餵食", amount: log['第二次 飲食奶量(cc)'], other: log['第二次 飲食其他飲食'] });
                    if (log['第三次 飲食']) feedingDetails.push({ time: extractTime(log['第三次 飲食']), label: "第三次餵食", amount: log['第三次 飲食奶量(cc)'], other: log['第三次 飲食其他飲食'] });

                    sectionContent = feedingDetails.map(f => `
                        <div class="detail-row">
                            <div class="detail-item"><strong>${f.label}:</strong> ${f.time}</div>
                            <div class="detail-item"><strong>奶量:</strong> ${f.amount || 'N/A'} cc</div>
                            ${f.other && String(f.other).trim() !== '' ? `<div class="detail-item"><strong>其他飲食:</strong> ${f.other}</div>` : ''}
                        </div>
                    `).join('');
                    
                    contentHTML += `<div class="log-section feeding-theme">
                        <h4><span>🍼</span> 飲食記錄 (多餐次結構)</h4>${sectionContent}
                    </div>`;
                }

                // B. 睡眠 (藍色主題) - **已修改**
                sectionContent = '';
                if (log['第一次 睡眠'] || log['第二次 睡眠'] || log['第三次 睡眠']) {
                    if (log['第一次 睡眠']) sectionContent += `<div class="detail-item"><strong>第一次:</strong> ${extractTime(log['第一次 睡眠'])} (${log['第一次睡眠狀況'] || 'N/A'})</div>`;
                    if (log['第二次 睡眠']) sectionContent += `<div class="detail-item"><strong>第二次:</strong> ${extractTime(log['第二次 睡眠'])} (${log['第二次睡眠狀況'] || 'N/A'})</div>`;
                    if (log['第三次 睡眠']) sectionContent += `<div class="detail-item"><strong>第三次:</strong> ${extractTime(log['第三次 睡眠']) || 'N/A'}</div>`;
                    
                    contentHTML += `<div class="log-section sleeping-theme">
                        <h4><span>😴</span> 睡眠狀況</h4><div class="detail-row">${sectionContent}</div>
                    </div>`;
                }
                
                // C. 排便/清潔 (綠色主題) - **已修改**
                sectionContent = '';
                if (log['第一次 排便'] || log['洗澡時間'] || log['換尿布時間']) {
                    if (log['第一次 排便']) sectionContent += `<div class="detail-item"><strong>排便 1:</strong> ${extractTime(log['第一次 排便'])} (${log['第一次排便狀態'] || 'N/A'})</div>`;
                    if (log['第二次 排便']) sectionContent += `<div class="detail-item"><strong>排便 2:</strong> ${extractTime(log['第二次 排便'])} (${log['第二次排便狀態'] || 'N/A'})</div>`;
                    if (log['第三次 排便']) sectionContent += `<div class="detail-item"><strong>排便 3:</strong> ${extractTime(log['第三次 排便']) || 'N/A'} (${log['第三次 排便狀態'] || 'N/A'})</div>`;
                    
                    if (log['排便過多次數(次)']) sectionContent += `<div class="detail-item"><strong>過多次數:</strong> ${log['排便過多次數(次)']} 次</div>`;
                    if (log['換尿布時間']) sectionContent += `<div class="detail-item"><strong>換尿布:</strong> ${extractTime(log['換尿布時間']) || 'N/A'}</div>`;
                    if (log['洗澡時間']) sectionContent += `<div class="detail-item"><strong>洗澡:</strong> ${extractTime(log['洗澡時間']) || 'N/A'}</div>`;
                    if (log['口腔清潔或刷牙時間']) sectionContent += `<div class="detail-item"><strong>口腔清潔:</strong> ${extractTime(log['口腔清潔或刷牙時間']) || 'N/A'}</div>`;
                    
                    contentHTML += `<div class="log-section diaper-theme">
                        <h4><span>🚽</span> 清潔與排泄</h4><div class="detail-row">${sectionContent}</div>
                    </div>`;
                }


                // D. 體溫/情緒/意外 (紅色主題)
                sectionContent = '';
                // 檢查體溫欄位
                if (log['體溫'] && String(log['體溫']).trim() !== '' && log['體溫'] !== 'N/A') {
                    sectionContent += `<div class="detail-item"><strong>體溫:</strong> ${log['體溫']}°C</div>`;
                } else if (log['體溫 上午'] || log['體溫 中午'] || log['體溫 下午'] || log['體溫 晚上']) {
                    sectionContent += `<div class="detail-item"><strong>上午:</strong> ${log['體溫 上午'] || 'N/A'}°C</div>`;
                    sectionContent += `<div class="detail-item"><strong>中午:</strong> ${log['體溫 中午'] || 'N/A'}°C</div>`;
                    sectionContent += `<div class="detail-item"><strong>下午:</strong> ${log['體溫 下午'] || 'N/A'}°C</div>`;
                    sectionContent += `<div class="detail-item"><strong>晚上:</strong> ${log['體溫 晚上'] || 'N/A'}°C</div>`;
                }
                
                if (log['寶寶情緒'] || log['身體狀況'] || log['意外狀況'] || sectionContent !== '') {
                    
                    contentHTML += `<div class="log-section health-theme">
                        <h4><span>🌡️</span> 體溫與狀態</h4>
                        
                        <div class="detail-row">${sectionContent}</div>
                        
                        <div class="detail-row">
                            <div class="detail-item"><strong>寶寶情緒:</strong> ${log['寶寶情緒'] || 'N/A'}</div>
                        </div>
                        
                        <div class="detail-row">
                            ${log['身體狀況'] && String(log['身體狀況']).trim() !== '' ? `<div class="detail-item"><strong>身體狀況:</strong> ${log['身體狀況']}</div>` : ''}
                            ${log['意外狀況'] && String(log['意外狀況']).trim() !== '' ? `<div class="detail-item"><strong>意外狀況:</strong> ${log['意外狀況']}</div>` : ''}
                        </div>
                    </div>`;
                }

                // E. 聯絡事項與回饋 (灰色主題) - 已加入「寶寶活動狀況」
                if (log['褓姆聯絡事項'] || log['對於今日寶寶狀況分享與回饋'] || log['寶寶活動狀況']) {
                    sectionContent = '';
                    
                    // 1. 活動狀況 (已移到這裡)
                    if (log['寶寶活動狀況'] && String(log['寶寶活動狀況']).trim() !== '') {
                        sectionContent += `<div class="detail-row"><div class="detail-item"><strong>寶寶活動狀況:</strong> ${log['寶寶活動狀況']}</div></div>`;
                    }
                    
                    // 2. 褓姆聯絡事項
                    if (log['褓姆聯絡事項'] && String(log['褓姆聯絡事項']).trim() !== '') {
                        sectionContent += `<div class="detail-row"><div class="detail-item"><strong>褓姆聯絡事項:</strong> ${log['褓姆聯絡事項']}</div></div>`;
                    }
                    
                    // 3. 家長回饋
                    if (log['對於今日寶寶狀況分享與回饋'] && String(log['對於今日寶寶狀況分享與回饋']).trim() !== '') {
                        sectionContent += `<div class="detail-row"><div class="detail-item"><strong>家長回饋:</strong> ${log['對於今日寶寶狀況分享與回饋']}</div></div>`;
                    }
                    
                    contentHTML += `<div class="log-section contact-theme">
                        <h4><span>📝</span> 聯絡與回饋</h4>${sectionContent}
                    </div>`;
                }
                

                contentHTML += '</div>'; // 關閉 log-content

                card.innerHTML = cardHeader + contentHTML;
                outputDiv.appendChild(card);
            });
        }

        document.addEventListener('DOMContentLoaded', loadBabyLogs);
    </script>
</body>
</html>
